name: Screenshot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"

      - name: Set Desktop Background
        run: |
          # Use a nice macOS wallpaper
          WALLPAPER="/System/Library/Desktop Pictures/Sequoia Sunrise.heic"
          if [ ! -f "$WALLPAPER" ]; then
            WALLPAPER=$(find /System/Library/Desktop\ Pictures -name "*.heic" | head -1)
          fi
          if [ -n "$WALLPAPER" ] && [ -f "$WALLPAPER" ]; then
            osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"$WALLPAPER\""
            sleep 1
          fi

      - name: Build and Screenshot
        run: make screenshot

      - name: Generate Icon PNG
        run: |
          sips -s format png ClipKitty.app/Contents/Resources/AppIcon.icns --out icon.png
          ls -lh screenshot.png icon.png

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assets
          path: |
            screenshot.png
            icon.png

      - name: Deploy to gh-pages
        if: github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin gh-pages || true
          rm -rf /tmp/gh-pages
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git worktree add /tmp/gh-pages gh-pages
            cd /tmp/gh-pages
            git pull origin gh-pages || true
          else
            git worktree add --detach /tmp/gh-pages
            cd /tmp/gh-pages
            git checkout --orphan gh-pages
            git reset --hard
          fi

          cp "$GITHUB_WORKSPACE/screenshot.png" .
          cp "$GITHUB_WORKSPACE/icon.png" .
          git add screenshot.png icon.png
          git commit -m "Update screenshot and icon [skip ci]" || echo "No changes to commit"
          git push origin gh-pages
          cd -
          git worktree remove /tmp/gh-pages --force

      - name: Output URLs
        if: github.ref == 'refs/heads/main'
        run: |
          REPO="${{ github.repository }}"
          echo "Screenshot: https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png"
          echo "Icon: https://raw.githubusercontent.com/$REPO/gh-pages/icon.png"
