name: Screenshot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Build App
        run: |
          make

      - name: Populate Database
        run: swift run PopulateTestData

      - name: Launch App with Panel Open
        run: |
          open -a "$PWD/ClipKitty.app" --args --show-panel
          sleep 3

      - name: Take Screenshot
        run: |
          sleep 0.2
          screencapture -x screenshot.png
          ls -lh screenshot.png

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: screenshot.png

      - name: Deploy to gh-pages
        if: github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create or update gh-pages via worktree to avoid touching main working tree
          git fetch origin gh-pages || true
          rm -rf /tmp/gh-pages
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git worktree add /tmp/gh-pages gh-pages
            cd /tmp/gh-pages
            git pull origin gh-pages || true
          else
            # Create orphan branch: worktree from current HEAD, then reset to orphan
            git worktree add -B gh-pages /tmp/gh-pages HEAD
            cd /tmp/gh-pages
            git checkout --orphan gh-pages
            git reset --hard
          fi

          cp "$GITHUB_WORKSPACE/screenshot.png" .
          git add screenshot.png
          git commit -m "Update screenshot [skip ci]" || echo "No changes to commit"
          git push origin gh-pages
          cd -
          git worktree remove /tmp/gh-pages --force

      - name: Output Screenshot URL
        if: github.ref == 'refs/heads/main'
        run: |
          REPO="${{ github.repository }}"
          echo "ðŸ“¸ Screenshot URL:"
          echo "https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png"
          echo ""
          echo "Markdown for README:"
          echo "![ClipKitty Screenshot](https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png)"
