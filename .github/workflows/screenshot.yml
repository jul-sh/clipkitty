name: Screenshot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"

      - name: Build App
        run: |
          make

      - name: Populate Database
        run: swift run PopulateTestData

      - name: Set Desktop Background
        run: |
          # Use a nice macOS Sequoia wallpaper
          WALLPAPER="/System/Library/Desktop Pictures/Sequoia Sunrise.heic"
          if [ ! -f "$WALLPAPER" ]; then
            # Fallback to another system wallpaper
            WALLPAPER=$(find /System/Library/Desktop\ Pictures -name "*.heic" | head -1)
          fi
          if [ -n "$WALLPAPER" ] && [ -f "$WALLPAPER" ]; then
            osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"$WALLPAPER\""
            sleep 1
          fi

      - name: Take Screenshot
        run: |
          # Debug: Check if app exists
          ls -la "$PWD/ClipKitty.app/Contents/MacOS/"

          # Launch app with panel visible
          echo "Launching ClipKitty..."
          "$PWD/ClipKitty.app/Contents/MacOS/ClipKitty" --show-panel --search "fetch" &
          APP_PID=$!
          echo "App PID: $APP_PID"

          # Wait for app to fully launch and load items
          sleep 5

          # Debug: Check if app is running
          echo "Running processes:"
          pgrep -l ClipKitty || echo "ClipKitty not found in process list"
          ps aux | grep -i clipkitty | grep -v grep || true

          # Debug: Get app logs
          echo "App logs:"
          log show --predicate 'subsystem == "com.clipkitty.app" OR process == "ClipKitty"' --last 30s 2>/dev/null | tail -50 || true

          # Debug: List all windows
          echo "Windows:"
          osascript -e 'tell application "System Events" to get name of every window of every process whose visible is true' 2>/dev/null || true

          # Take full screen capture
          screencapture -x screenshot.png

          ls -lh screenshot.png

          # Debug: Check screenshot dimensions
          sips -g pixelWidth -g pixelHeight screenshot.png

          # Kill the app
          kill $APP_PID 2>/dev/null || true

      - name: Generate Icon PNG
        run: |
          # Convert compiled .icns to .png for documentation
          sips -s format png ClipKitty.app/Contents/Resources/AppIcon.icns --out icon.png
          ls -lh icon.png

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assets
          path: |
            screenshot.png
            icon.png

      - name: Deploy to gh-pages
        if: github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create or update gh-pages via worktree to avoid touching main working tree
          git fetch origin gh-pages || true
          rm -rf /tmp/gh-pages
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git worktree add /tmp/gh-pages gh-pages
            cd /tmp/gh-pages
            git pull origin gh-pages || true
          else
            # Create orphan branch: detached worktree, then create orphan inside
            git worktree add --detach /tmp/gh-pages
            cd /tmp/gh-pages
            git checkout --orphan gh-pages
            git reset --hard
          fi

          cp "$GITHUB_WORKSPACE/screenshot.png" .
          cp "$GITHUB_WORKSPACE/icon.png" .
          git add screenshot.png icon.png
          git commit -m "Update screenshot and icon [skip ci]" || echo "No changes to commit"
          git push origin gh-pages
          cd -
          git worktree remove /tmp/gh-pages --force

      - name: Output URLs
        if: github.ref == 'refs/heads/main'
        run: |
          REPO="${{ github.repository }}"
          echo "üì∏ Screenshot URL:"
          echo "https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png"
          echo "üñºÔ∏è Icon URL:"
          echo "https://raw.githubusercontent.com/$REPO/gh-pages/icon.png"
          echo ""
          echo "Markdown for README:"
          echo "![ClipKitty Screenshot](https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png)"
          echo "![ClipKitty Icon](https://raw.githubusercontent.com/$REPO/gh-pages/icon.png)"
