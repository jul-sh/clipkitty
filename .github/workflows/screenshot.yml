name: Screenshot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Build App
        run: |
          make

      - name: Populate Database
        run: swift run PopulateTestData

      - name: Launch App with Panel Open
        run: |
          open -a "$PWD/ClipKitty.app" --args --show-panel
          sleep 3

      - name: Take Screenshot
        run: |
          screencapture -x screenshot.png
          ls -lh screenshot.png

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: screenshot.png

      - name: Deploy to gh-pages
        if: github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create orphan gh-pages branch if it doesn't exist
          git fetch origin gh-pages || true

          # Create temp directory for gh-pages content
          mkdir -p /tmp/gh-pages

          # If gh-pages exists, preserve existing files
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout origin/gh-pages -- . 2>/dev/null || true
            cp -r * /tmp/gh-pages/ 2>/dev/null || true
          fi
          cp screenshot.png /tmp/gh-pages/

          # Switch to gh-pages branch
          git checkout --orphan gh-pages-new || git checkout -B gh-pages-new

          # Clear working directory
          git rm -rf . 2>/dev/null || true

          # Copy files back
          cp -r /tmp/gh-pages/* . 2>/dev/null || cp /tmp/gh-pages/screenshot.png .

          # Commit and push
          git add screenshot.png
          git commit -m "Update screenshot [skip ci]" || echo "No changes to commit"
          git push origin gh-pages-new:gh-pages --force

      - name: Output Screenshot URL
        if: github.ref == 'refs/heads/main'
        run: |
          REPO="${{ github.repository }}"
          echo "ðŸ“¸ Screenshot URL:"
          echo "https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png"
          echo ""
          echo "Markdown for README:"
          echo "![ClipKitty Screenshot](https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png)"
