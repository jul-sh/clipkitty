name: Screenshot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"

      - name: Build App
        run: |
          make

      - name: Populate Database
        run: swift run PopulateTestData

      - name: Set Desktop Background
        run: |
          # Use a nice macOS Sequoia wallpaper
          WALLPAPER="/System/Library/Desktop Pictures/Sequoia Sunrise.heic"
          if [ ! -f "$WALLPAPER" ]; then
            # Fallback to another system wallpaper
            WALLPAPER=$(find /System/Library/Desktop\ Pictures -name "*.heic" | head -1)
          fi
          if [ -n "$WALLPAPER" ] && [ -f "$WALLPAPER" ]; then
            osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"$WALLPAPER\""
            sleep 1
          fi

      - name: Take Screenshot
        run: |
          # Launch app with panel visible and a search query to showcase fuzzy search
          open -a "$PWD/ClipKitty.app" --args --show-panel --search "fetch"
          sleep 2

          # Get the window ID for ClipKitty panel
          WINDOW_ID=$(osascript -e 'tell application "System Events" to get id of first window of (first process whose name is "ClipKitty")' 2>/dev/null || echo "")

          if [ -n "$WINDOW_ID" ]; then
            # Capture just the app window (with shadow for nice presentation)
            screencapture -l "$WINDOW_ID" screenshot.png
          else
            # Fallback: capture the front window
            screencapture -w screenshot.png
          fi

          ls -lh screenshot.png

      - name: Generate Icon PNG
        run: |
          # Convert compiled .icns to .png for documentation
          sips -s format png ClipKitty.app/Contents/Resources/AppIcon.icns --out icon.png
          ls -lh icon.png

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assets
          path: |
            screenshot.png
            icon.png

      - name: Deploy to gh-pages
        if: github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create or update gh-pages via worktree to avoid touching main working tree
          git fetch origin gh-pages || true
          rm -rf /tmp/gh-pages
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git worktree add /tmp/gh-pages gh-pages
            cd /tmp/gh-pages
            git pull origin gh-pages || true
          else
            # Create orphan branch: detached worktree, then create orphan inside
            git worktree add --detach /tmp/gh-pages
            cd /tmp/gh-pages
            git checkout --orphan gh-pages
            git reset --hard
          fi

          cp "$GITHUB_WORKSPACE/screenshot.png" .
          cp "$GITHUB_WORKSPACE/icon.png" .
          git add screenshot.png icon.png
          git commit -m "Update screenshot and icon [skip ci]" || echo "No changes to commit"
          git push origin gh-pages
          cd -
          git worktree remove /tmp/gh-pages --force

      - name: Output URLs
        if: github.ref == 'refs/heads/main'
        run: |
          REPO="${{ github.repository }}"
          echo "üì∏ Screenshot URL:"
          echo "https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png"
          echo "üñºÔ∏è Icon URL:"
          echo "https://raw.githubusercontent.com/$REPO/gh-pages/icon.png"
          echo ""
          echo "Markdown for README:"
          echo "![ClipKitty Screenshot](https://raw.githubusercontent.com/$REPO/gh-pages/screenshot.png)"
          echo "![ClipKitty Icon](https://raw.githubusercontent.com/$REPO/gh-pages/icon.png)"
