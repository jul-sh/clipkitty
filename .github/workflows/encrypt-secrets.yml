name: Encrypt Secrets
on:
  workflow_dispatch:
  push:
    branches: [asc]
    paths: ['.github/workflows/encrypt-secrets.yml']
permissions:
  contents: write
jobs:
  encrypt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install age
        run: sudo apt-get install -y age
      - name: Encrypt secrets
        env:
          SECRET_ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          SECRET_APPSTORE_CERT_BASE64: ${{ secrets.APPSTORE_CERT_BASE64 }}
          SECRET_APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          SECRET_HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          SECRET_MACOS_P12_BASE64: ${{ secrets.MACOS_P12_BASE64 }}
          SECRET_MACOS_P12_PASSWORD: ${{ secrets.MACOS_P12_PASSWORD }}
          SECRET_MACOS_TEAM_ID: ${{ secrets.MACOS_TEAM_ID }}
          SECRET_NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
          SECRET_NOTARY_KEY_BASE64: ${{ secrets.NOTARY_KEY_BASE64 }}
          SECRET_NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          SECRET_P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          SECRET_PROVISION_PROFILE_BASE64: ${{ secrets.PROVISION_PROFILE_BASE64 }}
        run: |
          mkdir -p secrets
          for var in $(env | grep '^SECRET_' | cut -d= -f1 | sort); do
            name="${var#SECRET_}"
            printenv "$var" | age -e -R secrets/age-recipients.txt -o "secrets/${name}.age"
            echo "Encrypted: ${name}"
          done
      - name: Commit encrypted secrets
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add secrets/*.age
          git diff --cached --quiet || git commit -m "Update encrypted secrets"
          git push
