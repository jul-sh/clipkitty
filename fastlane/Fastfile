default_platform(:mac)

platform :mac do
  def api_key
    app_store_connect_api_key(
      key_id: ENV.fetch("APPSTORE_KEY_ID"),
      issuer_id: ENV.fetch("APPSTORE_ISSUER_ID"),
      key_content: ENV.fetch("APPSTORE_KEY_CONTENT"),
      is_key_content_base64: true
    )
  end

  desc "Upload build, metadata, and screenshots to App Store Connect"
  lane :release do
    deliver(
      api_key: api_key,
      pkg: File.join(Dir.pwd, "..", "ClipKitty.pkg"),
      force: true,
      run_precheck_before_submit: false,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload build only (no metadata update)"
  lane :upload do
    deliver(
      api_key: api_key,
      pkg: File.join(Dir.pwd, "..", "ClipKitty.pkg"),
      skip_metadata: true,
      skip_screenshots: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "Update metadata and screenshots only (no build upload)"
  lane :metadata do
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "Submit the latest build for App Review"
  lane :submit do
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: true,
      force: true,
      run_precheck_before_submit: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end
end
