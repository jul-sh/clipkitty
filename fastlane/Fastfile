default_platform(:mac)

METADATA_DIR = File.join(Dir.pwd, "metadata")

platform :mac do
  def api_key
    app_store_connect_api_key(
      key_id: ENV.fetch("APPSTORE_KEY_ID"),
      issuer_id: ENV.fetch("APPSTORE_ISSUER_ID"),
      key_content: ENV.fetch("APPSTORE_KEY_CONTENT"),
      is_key_content_base64: true
    )
  end

  # Common deliver options shared across lanes
  def deliver_defaults
    {
      api_key: api_key,
      force: true,
      run_precheck_before_submit: false,
      precheck_include_in_app_purchases: false,
      price_tier: 7,
      app_rating_config_path: File.join(METADATA_DIR, "rating_config.json"),
      app_privacy_details_path: File.join(METADATA_DIR, "app_privacy_details.json")
    }
  end

  desc "Upload build, metadata, and screenshots to App Store Connect"
  lane :release do
    deliver(
      **deliver_defaults,
      pkg: File.join(Dir.pwd, "..", "ClipKitty.pkg")
    )
  end

  desc "Upload build only (no metadata update)"
  lane :upload do
    deliver(
      **deliver_defaults,
      pkg: File.join(Dir.pwd, "..", "ClipKitty.pkg"),
      skip_metadata: true,
      skip_screenshots: true
    )
  end

  desc "Update metadata and screenshots only (no build upload)"
  lane :metadata do
    deliver(
      **deliver_defaults,
      skip_binary_upload: true
    )
  end

  desc "Submit the latest build for App Review"
  lane :submit do
    deliver(
      **deliver_defaults,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: true,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end
end
